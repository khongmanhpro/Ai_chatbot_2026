version: '3.8'

###########################################################################################
# LightRAG Production Docker Compose
# Environment: Production
# Last Updated: 2026-01-05
#
# CRITICAL: This is for PRODUCTION use
# - High availability configuration
# - Persistent storage with backups
# - Monitoring and health checks
# - Resource limits
#
# Usage:
#   docker-compose -f docker-compose.prod.yml up -d
#   docker-compose -f docker-compose.prod.yml down
#
# Requirements:
#   - Docker 20.10+
#   - Docker Compose 2.0+
#   - Configure .env.prod with production credentials
#   - Set up external PostgreSQL/Redis if not using containers
###########################################################################################

services:
  lightrag:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_ENV=production
    image: lightrag:1.4.9-production
    container_name: lightrag-prod
    restart: always
    ports:
      - "127.0.0.1:9621:9621"  # Only bind to localhost, use reverse proxy
    environment:
      - ENV_FILE=.env.prod
    env_file:
      - .env.prod
    volumes:
      # Persist data (use named volumes for better management)
      - lightrag-inputs:/var/lib/lightrag/inputs
      - lightrag-storage:/var/lib/lightrag/rag_storage
      - lightrag-tiktoken:/var/lib/lightrag/tiktoken
      - lightrag-logs:/var/log/lightrag

      # SSL certificates (if using internal SSL)
      - /etc/ssl/certs:/etc/ssl/certs:ro
      - /etc/ssl/private:/etc/ssl/private:ro
    networks:
      - lightrag-prod
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 32G
        reservations:
          cpus: '4'
          memory: 16G
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9621/health"]
      interval: 20s
      timeout: 10s
      retries: 5
      start_period: 60s
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    labels:
      - "com.lightrag.environment=production"
      - "com.lightrag.version=1.4.9.11"
      - "com.lightrag.component=api"

  postgres:
    image: pgvector/pgvector:pg16
    container_name: lightrag-postgres-prod
    restart: always
    ports:
      - "127.0.0.1:5432:5432"  # Only bind to localhost
    environment:
      POSTGRES_DB: ${POSTGRES_DATABASE:-lightrag_production}
      POSTGRES_USER: ${POSTGRES_USER:-lightrag_prod}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_INITDB_ARGS: "-E UTF8 --locale=en_US.UTF-8"
      # Performance tuning
      POSTGRES_MAX_CONNECTIONS: 200
      POSTGRES_SHARED_BUFFERS: 8GB
      POSTGRES_EFFECTIVE_CACHE_SIZE: 24GB
      POSTGRES_WORK_MEM: 128MB
      POSTGRES_MAINTENANCE_WORK_MEM: 2GB
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./scripts/init-postgres.sql:/docker-entrypoint-initdb.d/init.sql
      - ./backups/postgres:/backups
    networks:
      - lightrag-prod
    command: >
      postgres
      -c shared_buffers=8GB
      -c effective_cache_size=24GB
      -c maintenance_work_mem=2GB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=16MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=128MB
      -c min_wal_size=1GB
      -c max_wal_size=4GB
      -c max_worker_processes=8
      -c max_parallel_workers_per_gather=4
      -c max_parallel_workers=8
      -c max_parallel_maintenance_workers=4
      -c ssl=on
      -c ssl_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem
      -c ssl_key_file=/etc/ssl/private/ssl-cert-snakeoil.key
    deploy:
      resources:
        limits:
          cpus: '8'
          memory: 32G
        reservations:
          cpus: '4'
          memory: 16G
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-lightrag_prod} -d ${POSTGRES_DATABASE:-lightrag_production}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "10"
    labels:
      - "com.lightrag.environment=production"
      - "com.lightrag.component=database"

  redis:
    image: redis:7-alpine
    container_name: lightrag-redis-prod
    restart: always
    ports:
      - "127.0.0.1:6379:6379"
    volumes:
      - redis-data:/data
      - ./config/redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: >
      redis-server
      /usr/local/etc/redis/redis.conf
      --appendonly yes
      --appendfsync everysec
      --maxmemory 8gb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
    networks:
      - lightrag-prod
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 8G
        reservations:
          cpus: '1'
          memory: 4G
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    labels:
      - "com.lightrag.environment=production"
      - "com.lightrag.component=cache"

  # Optional: Neo4j for advanced graph operations
  # neo4j:
  #   image: neo4j:5-enterprise
  #   container_name: lightrag-neo4j-prod
  #   restart: always
  #   ports:
  #     - "127.0.0.1:7474:7474"  # HTTP
  #     - "127.0.0.1:7687:7687"  # Bolt
  #   environment:
  #     NEO4J_AUTH: neo4j/${NEO4J_PASSWORD}
  #     NEO4J_ACCEPT_LICENSE_AGREEMENT: "yes"
  #     NEO4J_server_memory_heap_initial__size: 4G
  #     NEO4J_server_memory_heap_max__size: 8G
  #     NEO4J_server_memory_pagecache_size: 4G
  #     NEO4J_dbms_security_procedures_unrestricted: apoc.*
  #   volumes:
  #     - neo4j-data:/data
  #     - neo4j-logs:/logs
  #     - ./backups/neo4j:/backups
  #   networks:
  #     - lightrag-prod
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: '4'
  #         memory: 16G
  #       reservations:
  #         cpus: '2'
  #         memory: 8G
  #   healthcheck:
  #     test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD}", "RETURN 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 5
  #     start_period: 60s
  #   labels:
  #     - "com.lightrag.environment=production"
  #     - "com.lightrag.component=graph-database"

  # Nginx reverse proxy with SSL
  nginx:
    image: nginx:alpine
    container_name: lightrag-nginx-prod
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./config/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./config/nginx-lightrag.conf:/etc/nginx/conf.d/default.conf:ro
      - /etc/letsencrypt:/etc/letsencrypt:ro
      - nginx-logs:/var/log/nginx
    networks:
      - lightrag-prod
    depends_on:
      - lightrag
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    logging:
      driver: "json-file"
      options:
        max-size: "20m"
        max-file: "5"
    labels:
      - "com.lightrag.environment=production"
      - "com.lightrag.component=proxy"

  # PostgreSQL backup service
  postgres-backup:
    image: prodrigestivill/postgres-backup-local:16-alpine
    container_name: lightrag-postgres-backup
    restart: always
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_DB: ${POSTGRES_DATABASE:-lightrag_production}
      POSTGRES_USER: ${POSTGRES_USER:-lightrag_prod}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_EXTRA_OPTS: "--format=custom --blobs --verbose"
      SCHEDULE: "@daily"
      BACKUP_KEEP_DAYS: 30
      BACKUP_KEEP_WEEKS: 8
      BACKUP_KEEP_MONTHS: 12
      HEALTHCHECK_PORT: 8080
    volumes:
      - ./backups/postgres:/backups
    networks:
      - lightrag-prod
    depends_on:
      postgres:
        condition: service_healthy
    labels:
      - "com.lightrag.environment=production"
      - "com.lightrag.component=backup"

  # Monitoring: Prometheus (optional but recommended)
  # prometheus:
  #   image: prom/prometheus:latest
  #   container_name: lightrag-prometheus
  #   restart: always
  #   ports:
  #     - "127.0.0.1:9090:9090"
  #   volumes:
  #     - ./config/prometheus.yml:/etc/prometheus/prometheus.yml:ro
  #     - prometheus-data:/prometheus
  #   command:
  #     - '--config.file=/etc/prometheus/prometheus.yml'
  #     - '--storage.tsdb.path=/prometheus'
  #     - '--storage.tsdb.retention.time=30d'
  #   networks:
  #     - lightrag-prod
  #   labels:
  #     - "com.lightrag.environment=production"
  #     - "com.lightrag.component=monitoring"

  # Monitoring: Grafana (optional but recommended)
  # grafana:
  #   image: grafana/grafana:latest
  #   container_name: lightrag-grafana
  #   restart: always
  #   ports:
  #     - "127.0.0.1:3000:3000"
  #   environment:
  #     GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD}
  #     GF_INSTALL_PLUGINS: grafana-piechart-panel
  #   volumes:
  #     - grafana-data:/var/lib/grafana
  #     - ./config/grafana-dashboards:/etc/grafana/provisioning/dashboards:ro
  #   networks:
  #     - lightrag-prod
  #   depends_on:
  #     - prometheus
  #   labels:
  #     - "com.lightrag.environment=production"
  #     - "com.lightrag.component=monitoring"

networks:
  lightrag-prod:
    name: lightrag-production
    driver: bridge
    ipam:
      config:
        - subnet: 172.25.0.0/16

volumes:
  lightrag-inputs:
    name: lightrag-prod-inputs
    driver: local
  lightrag-storage:
    name: lightrag-prod-storage
    driver: local
  lightrag-tiktoken:
    name: lightrag-prod-tiktoken
    driver: local
  lightrag-logs:
    name: lightrag-prod-logs
    driver: local
  postgres-data:
    name: lightrag-prod-postgres
    driver: local
  redis-data:
    name: lightrag-prod-redis
    driver: local
  nginx-logs:
    name: lightrag-prod-nginx-logs
    driver: local
  # neo4j-data:
  #   name: lightrag-prod-neo4j-data
  #   driver: local
  # neo4j-logs:
  #   name: lightrag-prod-neo4j-logs
  #   driver: local
  # prometheus-data:
  #   name: lightrag-prod-prometheus
  #   driver: local
  # grafana-data:
  #   name: lightrag-prod-grafana
  #   driver: local
