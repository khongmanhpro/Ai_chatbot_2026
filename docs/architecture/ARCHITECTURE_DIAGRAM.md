# LightRAG Architecture Diagram

**Version**: 1.0
**Last Updated**: 2026-01-05
**Document Purpose**: High-level system architecture and data flow diagrams

---

## ğŸ—ï¸ System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USERS / CLIENTS                                 â”‚
â”‚                        (Web Browser, API Clients, CLI)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTPS/WSS
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         REVERSE PROXY / LOAD BALANCER                        â”‚
â”‚                     (Nginx, Traefik, Cloudflare, AWS ALB)                    â”‚
â”‚                                                                               â”‚
â”‚  Features:                                                                    â”‚
â”‚  âœ“ SSL/TLS Termination          âœ“ Rate Limiting                             â”‚
â”‚  âœ“ Load Balancing               âœ“ DDoS Protection                           â”‚
â”‚  âœ“ Request Routing              âœ“ Compression                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ HTTP
                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         LIGHTRAG APPLICATION LAYER                           â”‚
â”‚                           (FastAPI + Gunicorn)                               â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Web UI Server   â”‚  â”‚   REST API Server  â”‚  â”‚  Ollama-Compatible API â”‚ â”‚
â”‚  â”‚   (React 19 SPA)  â”‚  â”‚   (FastAPI Routes) â”‚  â”‚    (Chat Interface)    â”‚ â”‚
â”‚  â”‚                   â”‚  â”‚                    â”‚  â”‚                        â”‚ â”‚
â”‚  â”‚ â€¢ Document Upload â”‚  â”‚ â€¢ /documents/*     â”‚  â”‚ â€¢ /v1/chat/completions â”‚ â”‚
â”‚  â”‚ â€¢ Graph Explorer  â”‚  â”‚ â€¢ /query/*         â”‚  â”‚ â€¢ /v1/models           â”‚ â”‚
â”‚  â”‚ â€¢ Query Interface â”‚  â”‚ â€¢ /graph/*         â”‚  â”‚                        â”‚ â”‚
â”‚  â”‚ â€¢ Auth Pages      â”‚  â”‚ â€¢ Authentication   â”‚  â”‚                        â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚            â”‚                       â”‚                         â”‚              â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                    â”‚                                         â”‚
â”‚                                    â–¼                                         â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚            â”‚      LightRAG Core Engine (lightrag.py)      â”‚                 â”‚
â”‚            â”‚                                               â”‚                 â”‚
â”‚            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                 â”‚
â”‚            â”‚  â”‚   Document   â”‚    â”‚  Query Processor â”‚   â”‚                 â”‚
â”‚            â”‚  â”‚   Processor  â”‚    â”‚                  â”‚   â”‚                 â”‚
â”‚            â”‚  â”‚              â”‚    â”‚  â€¢ naive mode    â”‚   â”‚                 â”‚
â”‚            â”‚  â”‚ â€¢ Chunking   â”‚    â”‚  â€¢ local mode    â”‚   â”‚                 â”‚
â”‚            â”‚  â”‚ â€¢ Extraction â”‚    â”‚  â€¢ global mode   â”‚   â”‚                 â”‚
â”‚            â”‚  â”‚ â€¢ KG Build   â”‚    â”‚  â€¢ hybrid mode   â”‚   â”‚                 â”‚
â”‚            â”‚  â”‚              â”‚    â”‚  â€¢ mix mode      â”‚   â”‚                 â”‚
â”‚            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚                 â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                   â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚               â”‚               â”‚
                    â–¼               â–¼               â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   LLM Provider   â”‚  â”‚   Embedding   â”‚  â”‚  Rerank Service  â”‚
     â”‚                  â”‚  â”‚   Provider    â”‚  â”‚                  â”‚
     â”‚ â€¢ OpenAI GPT-4o  â”‚  â”‚ â€¢ OpenAI      â”‚  â”‚ â€¢ Cohere         â”‚
     â”‚ â€¢ Azure OpenAI   â”‚  â”‚ â€¢ Jina AI     â”‚  â”‚ â€¢ Jina AI        â”‚
     â”‚ â€¢ Google Gemini  â”‚  â”‚ â€¢ Ollama      â”‚  â”‚ â€¢ Aliyun         â”‚
     â”‚ â€¢ Anthropic      â”‚  â”‚ â€¢ Azure       â”‚  â”‚ â€¢ vLLM (local)   â”‚
     â”‚ â€¢ Ollama (local) â”‚  â”‚ â€¢ Gemini      â”‚  â”‚                  â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚               â”‚               â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           STORAGE LAYER                                      â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Key-Value      â”‚  â”‚  Vector Storage  â”‚  â”‚   Graph Storage          â”‚   â”‚
â”‚  â”‚  Storage        â”‚  â”‚                  â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚                 â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚ â€¢ Redis         â”‚  â”‚ â”‚  Embeddings  â”‚ â”‚  â”‚ â”‚   Nodes (Entities)   â”‚ â”‚   â”‚
â”‚  â”‚ â€¢ PostgreSQL    â”‚  â”‚ â”‚  Index       â”‚ â”‚  â”‚ â”‚   â”œâ”€ Person          â”‚ â”‚   â”‚
â”‚  â”‚ â€¢ MongoDB       â”‚  â”‚ â”‚              â”‚ â”‚  â”‚ â”‚   â”œâ”€ Organization     â”‚ â”‚   â”‚
â”‚  â”‚ â€¢ JSON Files    â”‚  â”‚ â”‚ HNSW / IVF   â”‚ â”‚  â”‚ â”‚   â”œâ”€ Location        â”‚ â”‚   â”‚
â”‚  â”‚                 â”‚  â”‚ â”‚ Index        â”‚ â”‚  â”‚ â”‚   â””â”€ Concept         â”‚ â”‚   â”‚
â”‚  â”‚ Stores:         â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚ â”‚                      â”‚ â”‚   â”‚
â”‚  â”‚ â€¢ Chunks        â”‚  â”‚                  â”‚  â”‚ â”‚   Edges (Relations)  â”‚ â”‚   â”‚
â”‚  â”‚ â€¢ Metadata      â”‚  â”‚ Implementations: â”‚  â”‚ â”‚   â”œâ”€ WORKS_FOR       â”‚ â”‚   â”‚
â”‚  â”‚ â€¢ Cache         â”‚  â”‚ â€¢ pgvector       â”‚  â”‚ â”‚   â”œâ”€ LOCATED_IN      â”‚ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ Milvus         â”‚  â”‚ â”‚   â””â”€ RELATES_TO      â”‚ â”‚   â”‚
â”‚                       â”‚ â€¢ Qdrant         â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â€¢ FAISS          â”‚  â”‚                          â”‚   â”‚
â”‚  â”‚  Doc Status     â”‚  â”‚ â€¢ NanoVectorDB   â”‚  â”‚ Implementations:         â”‚   â”‚
â”‚  â”‚  Storage        â”‚  â”‚ â€¢ MongoDB        â”‚  â”‚ â€¢ NetworkX (in-memory)   â”‚   â”‚
â”‚  â”‚                 â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â€¢ Neo4j                  â”‚   â”‚
â”‚  â”‚ â€¢ Redis         â”‚                        â”‚ â€¢ PostgreSQL (graph ext) â”‚   â”‚
â”‚  â”‚ â€¢ PostgreSQL    â”‚                        â”‚ â€¢ MongoDB                â”‚   â”‚
â”‚  â”‚ â€¢ JSON Files    â”‚                        â”‚ â€¢ Memgraph               â”‚   â”‚
â”‚  â”‚                 â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”‚ Tracks:         â”‚                                                        â”‚
â”‚  â”‚ â€¢ Processing    â”‚                                                        â”‚
â”‚  â”‚ â€¢ Completed     â”‚                                                        â”‚
â”‚  â”‚ â€¢ Failed        â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      OBSERVABILITY & MONITORING                              â”‚
â”‚                                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚   Langfuse     â”‚  â”‚   Application   â”‚  â”‚   Infrastructure Monitoring  â”‚ â”‚
â”‚  â”‚                â”‚  â”‚   Logs          â”‚  â”‚                              â”‚ â”‚
â”‚  â”‚ â€¢ Traces       â”‚  â”‚                 â”‚  â”‚ â€¢ Prometheus                 â”‚ â”‚
â”‚  â”‚ â€¢ Spans        â”‚  â”‚ â€¢ System Logs   â”‚  â”‚ â€¢ Grafana                    â”‚ â”‚
â”‚  â”‚ â€¢ Metrics      â”‚  â”‚ â€¢ Error Logs    â”‚  â”‚ â€¢ Datadog                    â”‚ â”‚
â”‚  â”‚ â€¢ Cost Track   â”‚  â”‚ â€¢ Access Logs   â”‚  â”‚ â€¢ CloudWatch                 â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Data Flow Diagrams

### 1. Document Ingestion Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚  Uploads    â”‚
â”‚  Document   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /documents/upload
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LightRAG API Server                         â”‚
â”‚                                                          â”‚
â”‚  1. Receive file (PDF, DOCX, PPTX, XLSX, TXT, MD)      â”‚
â”‚  2. Parse and extract text                              â”‚
â”‚  3. Save to INPUT_DIR                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ ainsert(text)
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Document Processing Pipeline                   â”‚
â”‚                                                          â”‚
â”‚  Step 1: Chunking                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ â€¢ Split by token size (default: 1200)     â”‚         â”‚
â”‚  â”‚ â€¢ Apply overlap (default: 100 tokens)     â”‚         â”‚
â”‚  â”‚ â€¢ Create chunk IDs                        â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â”‚                                      â”‚
â”‚                   â–¼                                      â”‚
â”‚  Step 2: Embedding Generation                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ â€¢ Batch chunks (default: 10 per batch)    â”‚         â”‚
â”‚  â”‚ â€¢ Call embedding API (OpenAI/Jina/Ollama) â”‚         â”‚
â”‚  â”‚ â€¢ Store embeddings in Vector DB           â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â”‚                                      â”‚
â”‚                   â–¼                                      â”‚
â”‚  Step 3: Entity Extraction (via LLM)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ â€¢ Send chunks to LLM                      â”‚         â”‚
â”‚  â”‚ â€¢ Extract entities (Person, Org, etc.)   â”‚         â”‚
â”‚  â”‚ â€¢ Extract relationships                   â”‚         â”‚
â”‚  â”‚ â€¢ Parse JSON response                     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â”‚                                      â”‚
â”‚                   â–¼                                      â”‚
â”‚  Step 4: Knowledge Graph Construction                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ â€¢ Merge duplicate entities               â”‚         â”‚
â”‚  â”‚ â€¢ Merge duplicate relationships          â”‚         â”‚
â”‚  â”‚ â€¢ Update graph structure                 â”‚         â”‚
â”‚  â”‚ â€¢ Link chunks to entities/relations      â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                   â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Parallel Storage
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚           â”‚           â”‚
        â–¼           â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   KV      â”‚ â”‚  Vector  â”‚ â”‚  Graph   â”‚
â”‚  Storage  â”‚ â”‚  Storage â”‚ â”‚  Storage â”‚
â”‚           â”‚ â”‚          â”‚ â”‚          â”‚
â”‚ â€¢ Chunks  â”‚ â”‚ â€¢ Embeds â”‚ â”‚ â€¢ Nodes  â”‚
â”‚ â€¢ Meta    â”‚ â”‚ â€¢ Index  â”‚ â”‚ â€¢ Edges  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚           â”‚           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚  Doc Status   â”‚
            â”‚  = COMPLETED  â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚   Response    â”‚
            â”‚   to User     â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 2. Query Processing Flow (Mix Mode)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    User     â”‚
â”‚   Query:    â”‚
â”‚ "What is X?"â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ POST /query
       â”‚ mode=mix, top_k=60
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              LightRAG Query Engine                           â”‚
â”‚                                                              â”‚
â”‚  Step 1: Query Analysis & Preparation                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚ â€¢ Parse query                             â”‚             â”‚
â”‚  â”‚ â€¢ Generate query embedding                â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚                   â”‚                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â”‚ Parallel Retrieval Paths
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
        â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Vector Retrieval   â”‚  â”‚   Knowledge Graph Retrieval     â”‚
â”‚                      â”‚  â”‚                                 â”‚
â”‚ 1. Embed query       â”‚  â”‚ 1. Local Search                 â”‚
â”‚ 2. Similarity search â”‚  â”‚    â€¢ Find entities near query   â”‚
â”‚ 3. Retrieve top-k    â”‚  â”‚    â€¢ Get 1-hop neighbors        â”‚
â”‚    chunks            â”‚  â”‚    â€¢ Collect related chunks     â”‚
â”‚                      â”‚  â”‚                                 â”‚
â”‚ Returns:             â”‚  â”‚ 2. Global Search                â”‚
â”‚ â€¢ Chunk texts        â”‚  â”‚    â€¢ Query community summaries  â”‚
â”‚ â€¢ Scores             â”‚  â”‚    â€¢ High-level relationships   â”‚
â”‚ â€¢ Source IDs         â”‚  â”‚                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ Returns:                        â”‚
           â”‚              â”‚ â€¢ Entity descriptions           â”‚
           â”‚              â”‚ â€¢ Relationship descriptions     â”‚
           â”‚              â”‚ â€¢ Connected chunk IDs           â”‚
           â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                            â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Context Merging & Deduplication  â”‚
        â”‚                                   â”‚
        â”‚  â€¢ Combine vector + KG results   â”‚
        â”‚  â€¢ Remove duplicate chunks       â”‚
        â”‚  â€¢ Apply token limits:           â”‚
        â”‚    - MAX_ENTITY_TOKENS           â”‚
        â”‚    - MAX_RELATION_TOKENS         â”‚
        â”‚    - MAX_TOTAL_TOKENS            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚     Reranking (if enabled)        â”‚
        â”‚                                   â”‚
        â”‚  â€¢ Send context + query to        â”‚
        â”‚    reranker (Cohere/Jina)        â”‚
        â”‚  â€¢ Reorder by relevance score    â”‚
        â”‚  â€¢ Filter by MIN_RERANK_SCORE    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    LLM Response Generation        â”‚
        â”‚                                   â”‚
        â”‚  Prompt:                          â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ System: You are a helpful   â”‚  â”‚
        â”‚  â”‚         assistant...        â”‚  â”‚
        â”‚  â”‚                             â”‚  â”‚
        â”‚  â”‚ Context: [Retrieved chunks  â”‚  â”‚
        â”‚  â”‚          + KG context]      â”‚  â”‚
        â”‚  â”‚                             â”‚  â”‚
        â”‚  â”‚ Query: What is X?           â”‚  â”‚
        â”‚  â”‚                             â”‚  â”‚
        â”‚  â”‚ Answer:                     â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚                                   â”‚
        â”‚  â€¢ Stream or non-stream response â”‚
        â”‚  â€¢ Extract citations if enabled  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Response    â”‚
                â”‚   to User     â”‚
                â”‚               â”‚
                â”‚ â€¢ Answer      â”‚
                â”‚ â€¢ Sources     â”‚
                â”‚ â€¢ Metadata    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 3. Query Mode Comparison

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          QUERY MODES                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                                 â”‚
â”‚   NAIVE     â”‚  Simple Vector Similarity                                      â”‚
â”‚   MODE      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚             â”‚  â”‚    Query     â”‚â”€â”€â”€â”€>â”‚ Vector DB    â”‚                        â”‚
â”‚             â”‚  â”‚  Embedding   â”‚     â”‚  Top-K       â”‚â”€â”€> LLM                 â”‚
â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚             â”‚  â€¢ Fastest                                                     â”‚
â”‚             â”‚  â€¢ No KG usage                                                 â”‚
â”‚             â”‚  â€¢ Best for: Simple factual queries                            â”‚
â”‚             â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                                 â”‚
â”‚   LOCAL     â”‚  Entity-Focused Context Retrieval                              â”‚
â”‚   MODE      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚             â”‚  â”‚    Query     â”‚â”€â”€â”€â”€>â”‚  Extract Keywords   â”‚                 â”‚
â”‚             â”‚  â”‚              â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚                             â”‚
â”‚             â”‚                                   â–¼                             â”‚
â”‚             â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚             â”‚                      â”‚ Find Matching Entities â”‚                â”‚
â”‚             â”‚                      â”‚ in Knowledge Graph     â”‚                â”‚
â”‚             â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚             â”‚                                 â”‚                               â”‚
â”‚             â”‚                                 â–¼                               â”‚
â”‚             â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚             â”‚                      â”‚ Get 1-hop Neighbors    â”‚                â”‚
â”‚             â”‚                      â”‚ + Related Chunks       â”‚â”€â”€> LLM         â”‚
â”‚             â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚             â”‚  â€¢ Detailed context                                            â”‚
â”‚             â”‚  â€¢ Best for: Specific entity queries                           â”‚
â”‚             â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                                 â”‚
â”‚   GLOBAL    â”‚  High-Level Relationship Retrieval                             â”‚
â”‚   MODE      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚             â”‚  â”‚    Query     â”‚â”€â”€â”€â”€>â”‚ Query Community      â”‚                â”‚
â”‚             â”‚  â”‚              â”‚     â”‚ Summaries            â”‚                â”‚
â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚             â”‚                                   â”‚                             â”‚
â”‚             â”‚                                   â–¼                             â”‚
â”‚             â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                â”‚
â”‚             â”‚                      â”‚ Aggregate High-Level   â”‚                â”‚
â”‚             â”‚                      â”‚ Relationships          â”‚â”€â”€> LLM         â”‚
â”‚             â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚             â”‚  â€¢ Bird's eye view                                             â”‚
â”‚             â”‚  â€¢ Best for: Broad conceptual queries                          â”‚
â”‚             â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                                 â”‚
â”‚   HYBRID    â”‚  Local + Global Combined                                       â”‚
â”‚   MODE      â”‚                                                                 â”‚
â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚             â”‚  â”‚   Local    â”‚        â”‚   Global   â”‚                          â”‚
â”‚             â”‚  â”‚   Search   â”‚        â”‚   Search   â”‚                          â”‚
â”‚             â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚             â”‚        â”‚                     â”‚                                  â”‚
â”‚             â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â”‚             â”‚                   â–¼                                             â”‚
â”‚             â”‚           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                     â”‚
â”‚             â”‚           â”‚ Merge Context â”‚â”€â”€> LLM                             â”‚
â”‚             â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                     â”‚
â”‚             â”‚  â€¢ Balanced approach                                           â”‚
â”‚             â”‚  â€¢ Best for: Complex multi-faceted queries                     â”‚
â”‚             â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                                 â”‚
â”‚    MIX      â”‚  KG + Vector Integrated (DEFAULT - Recommended)                â”‚
â”‚   MODE      â”‚                                                                 â”‚
â”‚             â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚             â”‚  â”‚   Vector   â”‚   â”‚   Local    â”‚   â”‚   Global   â”‚             â”‚
â”‚             â”‚  â”‚   Search   â”‚   â”‚   Search   â”‚   â”‚   Search   â”‚             â”‚
â”‚             â”‚  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚             â”‚        â”‚                â”‚                â”‚                      â”‚
â”‚             â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚             â”‚                         â–¼                                       â”‚
â”‚             â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚             â”‚              â”‚  Intelligent Merge   â”‚                           â”‚
â”‚             â”‚              â”‚  â€¢ Deduplicate       â”‚                           â”‚
â”‚             â”‚              â”‚  â€¢ Score & Rank      â”‚                           â”‚
â”‚             â”‚              â”‚  â€¢ Apply Token Limitsâ”‚                           â”‚
â”‚             â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚             â”‚                         â”‚                                       â”‚
â”‚             â”‚                         â–¼                                       â”‚
â”‚             â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚             â”‚              â”‚  Optional Reranking  â”‚â”€â”€> LLM                   â”‚
â”‚             â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚             â”‚  â€¢ Best accuracy                                               â”‚
â”‚             â”‚  â€¢ Best for: Most production use cases                         â”‚
â”‚             â”‚                                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚             â”‚                                                                 â”‚
â”‚   BYPASS    â”‚  Direct LLM Query (No RAG)                                     â”‚
â”‚   MODE      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚             â”‚  â”‚    Query     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> LLM                     â”‚
â”‚             â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚             â”‚  â€¢ No retrieval                                                â”‚
â”‚             â”‚  â€¢ Uses LLM's internal knowledge only                          â”‚
â”‚             â”‚  â€¢ Best for: General knowledge queries                         â”‚
â”‚             â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Deployment Architecture

### Non-Production (Simple)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Single Server (Ubuntu)                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           LightRAG Application                     â”‚    â”‚
â”‚  â”‚           Port: 9621                               â”‚    â”‚
â”‚  â”‚                                                     â”‚    â”‚
â”‚  â”‚  â€¢ FastAPI Server (2 workers)                     â”‚    â”‚
â”‚  â”‚  â€¢ JSON Storage (local files)                     â”‚    â”‚
â”‚  â”‚  â€¢ NetworkX Graph (in-memory)                     â”‚    â”‚
â”‚  â”‚  â€¢ NanoVectorDB (local)                           â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                              â”‚
â”‚  Storage:                                                    â”‚
â”‚  /app/data/rag_storage/                                     â”‚
â”‚    â”œâ”€â”€ kv_storage.json                                      â”‚
â”‚    â”œâ”€â”€ doc_status.json                                      â”‚
â”‚    â”œâ”€â”€ graph.pkl                                            â”‚
â”‚    â””â”€â”€ vector_db/                                           â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ External API Calls
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   OpenAI / Ollama   â”‚
â”‚   LLM + Embeddings  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Production (Scalable)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Internet / Users                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   CDN / DDoS Protection â”‚
                    â”‚   (Cloudflare / AWS)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Load Balancer        â”‚
                    â”‚    (AWS ALB / Nginx)    â”‚
                    â”‚                         â”‚
                    â”‚  â€¢ SSL Termination      â”‚
                    â”‚  â€¢ Health Checks        â”‚
                    â”‚  â€¢ Session Affinity     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚               â”‚               â”‚
                 â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  LightRAG App   â”‚ â”‚  LightRAG App   â”‚ â”‚  LightRAG App   â”‚
    â”‚   Instance 1    â”‚ â”‚   Instance 2    â”‚ â”‚   Instance N    â”‚
    â”‚                 â”‚ â”‚                 â”‚ â”‚                 â”‚
    â”‚ â€¢ Gunicorn      â”‚ â”‚ â€¢ Gunicorn      â”‚ â”‚ â€¢ Gunicorn      â”‚
    â”‚ â€¢ 4 workers     â”‚ â”‚ â€¢ 4 workers     â”‚ â”‚ â€¢ 4 workers     â”‚
    â”‚ â€¢ Stateless     â”‚ â”‚ â€¢ Stateless     â”‚ â”‚ â€¢ Stateless     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                   â”‚                   â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚ Shared Storage Access
                                 â”‚
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
             â”‚                   â”‚                   â”‚
             â–¼                   â–¼                   â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚   PostgreSQL    â”‚ â”‚      Redis      â”‚ â”‚     Neo4j       â”‚
    â”‚   (Primary DB)  â”‚ â”‚   (Cache Layer) â”‚ â”‚   (Graph DB)    â”‚
    â”‚                 â”‚ â”‚                 â”‚ â”‚   (Optional)    â”‚
    â”‚ â€¢ KV Storage    â”‚ â”‚ â€¢ LLM Cache    â”‚ â”‚                 â”‚
    â”‚ â€¢ Vector Store  â”‚ â”‚ â€¢ Doc Status   â”‚ â”‚ â€¢ Entities      â”‚
    â”‚ â€¢ Graph Store   â”‚ â”‚ â€¢ Session      â”‚ â”‚ â€¢ Relations     â”‚
    â”‚   (pg extension)â”‚ â”‚                â”‚ â”‚                 â”‚
    â”‚                 â”‚ â”‚ â€¢ Sentinel for â”‚ â”‚ â€¢ Cluster       â”‚
    â”‚ â€¢ Replication   â”‚ â”‚   HA           â”‚ â”‚   (Optional)    â”‚
    â”‚ â€¢ Backup        â”‚ â”‚ â€¢ Persistence  â”‚ â”‚                 â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                   â”‚                   â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   External Services     â”‚
                    â”‚                         â”‚
                    â”‚ â€¢ OpenAI / Azure        â”‚
                    â”‚ â€¢ Cohere (Reranking)    â”‚
                    â”‚ â€¢ Langfuse (Monitoring) â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Backup & Monitoring   â”‚
                    â”‚                         â”‚
                    â”‚ â€¢ S3 / Cloud Storage    â”‚
                    â”‚ â€¢ Prometheus            â”‚
                    â”‚ â€¢ Grafana               â”‚
                    â”‚ â€¢ PagerDuty             â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ºï¸ Component Interaction Map

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        LightRAG Core Components                         â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    lightrag.py (Main Class)                       â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  Key Methods:                                                    â”‚ â”‚
â”‚  â”‚  â€¢ __init__()          - Initialize with LLM/embedding functionsâ”‚ â”‚
â”‚  â”‚  â€¢ ainsert()           - Async document insertion               â”‚ â”‚
â”‚  â”‚  â€¢ aquery()            - Async query execution                  â”‚ â”‚
â”‚  â”‚  â€¢ adelete_by_entity() - Delete documents                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚     â”‚     â”‚     â”‚                          â”‚
â”‚                           â”‚     â”‚     â”‚     â”‚                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚     â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚         â”‚                       â”‚     â”‚                       â”‚       â”‚
â”‚         â–¼                       â–¼     â–¼                       â–¼       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  operate.py â”‚        â”‚    utils.py     â”‚         â”‚  prompt.py  â”‚  â”‚
â”‚  â”‚             â”‚        â”‚                 â”‚         â”‚             â”‚  â”‚
â”‚  â”‚ â€¢ chunking  â”‚        â”‚ â€¢ token count   â”‚         â”‚ â€¢ Extract   â”‚  â”‚
â”‚  â”‚ â€¢ extract   â”‚        â”‚ â€¢ encoding      â”‚         â”‚   templates â”‚  â”‚
â”‚  â”‚ â€¢ kg_query  â”‚        â”‚ â€¢ compute_mdhashâ”‚         â”‚ â€¢ Query     â”‚  â”‚
â”‚  â”‚ â€¢ merge     â”‚        â”‚ â€¢ split_text    â”‚         â”‚   templates â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚         â”‚                       â”‚                           â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                 â”‚                                      â”‚
â”‚                                 â–¼                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                     base.py (Interfaces)                          â”‚ â”‚
â”‚  â”‚                                                                   â”‚ â”‚
â”‚  â”‚  â€¢ BaseKVStorage                                                 â”‚ â”‚
â”‚  â”‚  â€¢ BaseVectorStorage                                             â”‚ â”‚
â”‚  â”‚  â€¢ BaseGraphStorage                                              â”‚ â”‚
â”‚  â”‚  â€¢ DocStatusStorage                                              â”‚ â”‚
â”‚  â”‚  â€¢ QueryParam (dataclass)                                        â”‚ â”‚
â”‚  â”‚  â€¢ QueryResult (dataclass)                                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                 â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ Implementations
                                  â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                       â”‚                       â”‚
          â–¼                       â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   kg/ Storage   â”‚     â”‚  llm/ Providers â”‚     â”‚  api/ Server    â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ JsonKVStorage â”‚     â”‚ â€¢ openai.py     â”‚     â”‚ â€¢ lightrag_     â”‚
â”‚ â€¢ RedisKV       â”‚     â”‚ â€¢ ollama.py     â”‚     â”‚   server.py     â”‚
â”‚ â€¢ PGKVStorage   â”‚     â”‚ â€¢ gemini.py     â”‚     â”‚ â€¢ routers/      â”‚
â”‚ â€¢ MongoKV       â”‚     â”‚ â€¢ anthropic.py  â”‚     â”‚   - documents   â”‚
â”‚                 â”‚     â”‚ â€¢ azure_openai  â”‚     â”‚   - query       â”‚
â”‚ â€¢ NetworkXGraph â”‚     â”‚ â€¢ etc.          â”‚     â”‚   - graph       â”‚
â”‚ â€¢ Neo4JGraph    â”‚     â”‚                 â”‚     â”‚ â€¢ auth.py       â”‚
â”‚ â€¢ PGGraph       â”‚     â”‚ 18 LLM bindings â”‚     â”‚ â€¢ config.py     â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ NanoVectorDB  â”‚     â”‚                 â”‚     â”‚ 16 API files    â”‚
â”‚ â€¢ Milvus        â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ Qdrant        â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ â€¢ pgvector      â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚                 â”‚     â”‚                 â”‚     â”‚                 â”‚
â”‚ 17 storage implsâ”‚     â”‚                 â”‚     â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Security Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Security Layers                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                      â”‚
â”‚  Layer 1: Network Security                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ Firewall (UFW / Security Groups)                         â”‚    â”‚
â”‚  â”‚ â€¢ DDoS Protection (Cloudflare)                             â”‚    â”‚
â”‚  â”‚ â€¢ Rate Limiting (Nginx / API Gateway)                      â”‚    â”‚
â”‚  â”‚ â€¢ IP Whitelisting (Optional)                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  Layer 2: Transport Security                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ SSL/TLS 1.3 (Let's Encrypt)                             â”‚    â”‚
â”‚  â”‚ â€¢ HTTPS Everywhere                                         â”‚    â”‚
â”‚  â”‚ â€¢ HSTS Headers                                             â”‚    â”‚
â”‚  â”‚ â€¢ Certificate Pinning                                      â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  Layer 3: Application Security                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Authentication:                                            â”‚    â”‚
â”‚  â”‚   â€¢ JWT Tokens (HS256 / RS256)                            â”‚    â”‚
â”‚  â”‚   â€¢ API Keys (X-API-Key header)                           â”‚    â”‚
â”‚  â”‚   â€¢ Token Auto-Renewal (sliding expiration)               â”‚    â”‚
â”‚  â”‚   â€¢ Password Hashing (bcrypt)                             â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚ Authorization:                                             â”‚    â”‚
â”‚  â”‚   â€¢ Role-Based Access (Admin / User)                      â”‚    â”‚
â”‚  â”‚   â€¢ Endpoint-Level Permissions                            â”‚    â”‚
â”‚  â”‚   â€¢ Whitelist Paths (health, public APIs)                 â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚ Input Validation:                                          â”‚    â”‚
â”‚  â”‚   â€¢ Pydantic Models                                       â”‚    â”‚
â”‚  â”‚   â€¢ File Type Validation                                  â”‚    â”‚
â”‚  â”‚   â€¢ Size Limits                                           â”‚    â”‚
â”‚  â”‚   â€¢ SQL Injection Prevention (Parameterized Queries)      â”‚    â”‚
â”‚  â”‚   â€¢ XSS Protection (Content Security Policy)              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  Layer 4: Data Security                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ At Rest:                                                   â”‚    â”‚
â”‚  â”‚   â€¢ Database Encryption (PostgreSQL TDE)                   â”‚    â”‚
â”‚  â”‚   â€¢ Encrypted Volumes (LUKS / AWS EBS Encryption)         â”‚    â”‚
â”‚  â”‚   â€¢ Secure Key Storage (AWS KMS, HashiCorp Vault)         â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚ In Transit:                                                â”‚    â”‚
â”‚  â”‚   â€¢ SSL/TLS for all connections                           â”‚    â”‚
â”‚  â”‚   â€¢ PostgreSQL SSL Mode: require                          â”‚    â”‚
â”‚  â”‚   â€¢ Redis TLS (optional)                                  â”‚    â”‚
â”‚  â”‚   â€¢ Neo4j +s protocol                                     â”‚    â”‚
â”‚  â”‚                                                            â”‚    â”‚
â”‚  â”‚ Access Control:                                            â”‚    â”‚
â”‚  â”‚   â€¢ Database User Permissions (Least Privilege)           â”‚    â”‚
â”‚  â”‚   â€¢ Network Segmentation (Private Subnets)                â”‚    â”‚
â”‚  â”‚   â€¢ No Direct DB Access from Internet                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â”‚  Layer 5: Monitoring & Auditing                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ Request Logging (All API calls)                         â”‚    â”‚
â”‚  â”‚ â€¢ Authentication Audit Trail                              â”‚    â”‚
â”‚  â”‚ â€¢ Failed Login Attempts Tracking                          â”‚    â”‚
â”‚  â”‚ â€¢ Langfuse Traces (User actions)                          â”‚    â”‚
â”‚  â”‚ â€¢ Alert on Suspicious Activity                            â”‚    â”‚
â”‚  â”‚ â€¢ Regular Security Audits                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ Scalability Considerations

### Vertical Scaling (Single Instance)
```
Current Capacity:
  8 vCPU, 32GB RAM
  â”œâ”€ LLM concurrency: MAX_ASYNC=16
  â”œâ”€ Document processing: MAX_PARALLEL_INSERT=6
  â”œâ”€ Embedding concurrency: EMBEDDING_FUNC_MAX_ASYNC=16
  â””â”€ Estimated: 100-200 concurrent users

Upgrade to:
  16 vCPU, 64GB RAM
  â”œâ”€ LLM concurrency: MAX_ASYNC=32
  â”œâ”€ Document processing: MAX_PARALLEL_INSERT=12
  â”œâ”€ Embedding concurrency: EMBEDDING_FUNC_MAX_ASYNC=32
  â””â”€ Estimated: 300-500 concurrent users
```

### Horizontal Scaling (Multiple Instances)
```
Load Balancer
    â”‚
    â”œâ”€ App Instance 1 (8 vCPU, 32GB)
    â”œâ”€ App Instance 2 (8 vCPU, 32GB)
    â”œâ”€ App Instance 3 (8 vCPU, 32GB)
    â””â”€ App Instance N

Shared Backend:
    â”œâ”€ PostgreSQL (Read Replicas)
    â”œâ”€ Redis Cluster (Sentinel / Cluster Mode)
    â””â”€ Neo4j Cluster (Enterprise)

Capacity per instance: 100-200 users
Total: N Ã— 100-200 concurrent users
```

### Database Scaling
```
PostgreSQL:
  â”œâ”€ Primary-Replica (Read scaling)
  â”œâ”€ Connection Pooling (PgBouncer)
  â”œâ”€ Partitioning (Time-based)
  â””â”€ Archival Strategy

Redis:
  â”œâ”€ Sentinel (HA)
  â”œâ”€ Cluster Mode (Sharding)
  â””â”€ Persistence: AOF + RDB

Neo4j:
  â”œâ”€ Causal Cluster (Enterprise)
  â”œâ”€ Sharding by workspace
  â””â”€ Read Replicas
```

---

**END OF ARCHITECTURE DOCUMENT**
